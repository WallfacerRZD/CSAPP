# 虚拟内存

## 物理和虚拟寻址
早起的PC使用物理寻址, 现代处理器使用虚拟寻址.虚拟地址在被送到内存之前先转换成适当的物理地址.  


## 地址空间
地址空间: 是一个非负整数地址的有序集合, 如果地址空间中的整数是连续的, 它就是一个线性地址空间.   

虚拟地址空间: CPU从一个由N=![](http://chart.googleapis.com/chart?cht=tx&chl=2^{n})个地址的地址空间生成虚拟地址, 这个地址空间称为虚拟地址空间.虚拟地址空间的位数为n.   

物理地址空间: 对应于系统中物理内存的M个字节   

主存中的每个字节都有一个选自虚拟地址空间的虚拟地址和一个选自物理空间的物理地址.   

#### 虚拟内存作为缓存的工具
虚拟内存: 一个由存放在磁盘上的N个连续的字节大小的单元组成的数组. 每个字节都有一个唯一的虚拟地址, 作为到数组的索引.磁盘上的数组内容被缓存在主存中.  

虚拟页: 磁盘上被VM系统分割的块, 作为磁盘和主存之间的传输单元.   

物理页: 物理内存被分割成的块, 大小与虚拟页相同. 也称为页帧. 

任何时刻, 虚拟页面的集合都分为三个不相交的集合: 
1. 未分配的: VM系统还未分配(或者创建)的页. 未分配的块没有任何数据和它们关联, 因此不占任何磁盘空间.
2. 缓存的: 当前已缓存在物理内存中的已分配页.
3. 未缓存的: 未缓存在物理内存中的已分配页.

#### DRAM缓存的组织结构
DRAM缓存中的不命中比SRAM缓存中的不命中的花费的代价要昂贵得多.  

#### 页表
页表: 存放在物理内存中的数据结构, 将虚拟页映射到物理页. 页表就是一个页表条目的数组.虚拟地址空间中的每个页在页表中一个固定偏移量出都有一个页表条目(PTE)   

![页表](./0.jpg)   

#### 页命中
CPU读取虚拟内存中的一个字时, 地址翻译硬件将虚拟地址作为一个索引来定位对应的页表条目. 如果条目中的有效位为1, 说明已缓存在内存中. 然后使用条目中的物理内存地址构造出这个字的物理地址.

#### 缺页
DRAM缓存不命中称为缺页   

当虚拟内存对应的页表条目中有效位为0, 推断出当前虚拟页未缓存在内存中. 这时触发一个缺页异常. 缺页异常调用内核中的缺页异常处理程序. 缺页异常处理程序选择一个牺牲页, 如果牺牲页已经被修改, 内核将它复制会磁盘, 更新页表.然后重启导致缺页异常的指令.


#### 局部性
尽管整个运行过程中程序引用的不同页面的总是可能超过物理内存总数, 但局部性保证了再任意时刻, 程序将趋向于在一个较小的活动页面集合(工作集, 常驻集合)上工作.   

抖动: 工作集的大小超出了物理内存, 页面将不断地换进换出

